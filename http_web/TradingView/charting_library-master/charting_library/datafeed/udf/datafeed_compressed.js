"use strict";function SHA256(e){function t(e,t){var s=(65535&e)+(65535&t),a=(e>>16)+(t>>16)+(s>>16);return a<<16|65535&s}function s(e,t){return e>>>t|e<<32-t}function a(e,t){return e>>>t}function o(e,t,s){return e&t^~e&s}function i(e,t,s){return e&t^e&s^t&s}function n(e){return s(e,2)^s(e,13)^s(e,22)}function r(e){return s(e,6)^s(e,11)^s(e,25)}function l(e){return s(e,7)^s(e,18)^a(e,3)}function u(e){return s(e,17)^s(e,19)^a(e,10)}function f(e,s){var a,f,h,c,d,p,_,m,b,y,g,D,v=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),S=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),C=new Array(64);e[s>>5]|=128<<24-s%32,e[(s+64>>9<<4)+15]=s;for(var b=0;b<e.length;b+=16){a=S[0],f=S[1],h=S[2],c=S[3],d=S[4],p=S[5],_=S[6],m=S[7];for(var y=0;64>y;y++)16>y?C[y]=e[y+b]:C[y]=t(t(t(u(C[y-2]),C[y-7]),l(C[y-15])),C[y-16]),g=t(t(t(t(m,r(d)),o(d,p,_)),v[y]),C[y]),D=t(n(a),i(a,f,h)),m=_,_=p,p=d,d=t(c,g),c=h,h=f,f=a,a=t(g,D);S[0]=t(a,S[0]),S[1]=t(f,S[1]),S[2]=t(h,S[2]),S[3]=t(c,S[3]),S[4]=t(d,S[4]),S[5]=t(p,S[5]),S[6]=t(_,S[6]),S[7]=t(m,S[7])}return S}function h(e){for(var t=Array(),s=(1<<p)-1,a=0;a<e.length*p;a+=p)t[a>>5]|=(e.charCodeAt(a/p)&s)<<24-a%32;return t}function c(e){e=e.replace(/\r\n/g,"\n");for(var t="",s=0;s<e.length;s++){var a=e.charCodeAt(s);128>a?t+=String.fromCharCode(a):a>127&&2048>a?(t+=String.fromCharCode(a>>6|192),t+=String.fromCharCode(63&a|128)):(t+=String.fromCharCode(a>>12|224),t+=String.fromCharCode(a>>6&63|128),t+=String.fromCharCode(63&a|128))}return t}function d(e){for(var t=_?"0123456789ABCDEF":"0123456789abcdef",s="",a=0;a<4*e.length;a++)s+=t.charAt(e[a>>2]>>8*(3-a%4)+4&15)+t.charAt(e[a>>2]>>8*(3-a%4)&15);return s}var p=8,_=0;return e=c(e),d(f(h(e),e.length*p))}var Datafeeds={};Datafeeds.UDFCompatibleDatafeed=function(e,t,s){this._datafeedURL=e,this._configuration=void 0,this._symbolSearch=null,this._symbolsStorage=null,this._barsPulseUpdater=new Datafeeds.DataPulseUpdater(this,t||5e3),this._quotesPulseUpdater=new Datafeeds.QuotesPulseUpdater(this),this._protocolVersion=s||2,this._enableLogging=!1,this._initializationFinished=!1,this._callbacks={},this._initialize()},Datafeeds.UDFCompatibleDatafeed.prototype.defaultConfiguration=function(){return{supports_search:!1,supports_group_request:!0,supported_resolutions:["1m","3m","5m","15m","30m","60m","120m","240m","360m","720m","1D","2D","3D","W","3W","1M"],supports_marks:!1,supports_timescale_marks:!1}},Datafeeds.UDFCompatibleDatafeed.prototype.getServerTime=function(e){this._configuration.supports_time&&this._send(this._datafeedURL+"/time",{}).done(function(t){e(+t)}).fail(function(){})},Datafeeds.UDFCompatibleDatafeed.prototype.on=function(e,t){return this._callbacks.hasOwnProperty(e)||(this._callbacks[e]=[]),this._callbacks[e].push(t),this},Datafeeds.UDFCompatibleDatafeed.prototype._fireEvent=function(e,t){if(this._callbacks.hasOwnProperty(e)){for(var s=this._callbacks[e],a=0;a<s.length;++a)s[a](t);this._callbacks[e]=[]}},Datafeeds.UDFCompatibleDatafeed.prototype.onInitialized=function(){this._initializationFinished=!0,this._fireEvent("initialized")},Datafeeds.UDFCompatibleDatafeed.prototype._logMessage=function(e){if(this._enableLogging){var t=new Date;console.log(t.toLocaleTimeString()+"."+t.getMilliseconds()+"> "+e)}},Datafeeds.UDFCompatibleDatafeed.prototype._send=function(e,t){var s=e;if(t)for(var a=0;a<Object.keys(t).length;++a){var o=Object.keys(t)[a],i=encodeURIComponent(t[o]);s+=(0===a?"?":"&")+o+"="+i}return this._logMessage("New request: "+s),$.ajax({type:"GET",url:s,contentType:"text/plain"})},Datafeeds.UDFCompatibleDatafeed.prototype._initialize=function(){var e=this;this._send(this._datafeedURL+"/config").done(function(t){var s=JSON.parse(t);e._setupWithConfiguration(s)}).fail(function(t){e._setupWithConfiguration(e.defaultConfiguration())})},Datafeeds.UDFCompatibleDatafeed.prototype.onReady=function(e){if(this._configuration)e(this._configuration);else{var t=this;this.on("configuration_ready",function(){e(t._configuration)})}},Datafeeds.UDFCompatibleDatafeed.prototype._setupWithConfiguration=function(e){this._configuration=e,e.exchanges||(e.exchanges=[]);var t=e.supported_resolutions||e.supportedResolutions;e.supported_resolutions=t;var s=e.symbols_types||e.symbolsTypes;if(e.symbols_types=s,!e.supports_search&&!e.supports_group_request)throw"Unsupported datafeed configuration. Must either support search, or support group request";e.supports_search||(this._symbolSearch=new Datafeeds.SymbolSearchComponent(this)),e.supports_group_request?this._symbolsStorage=new Datafeeds.SymbolsStorage(this):this.onInitialized(),this._fireEvent("configuration_ready"),this._logMessage("Initialized with "+JSON.stringify(e))},Datafeeds.UDFCompatibleDatafeed.prototype.getMarks=function(e,t,s,a,o){this._configuration.supports_marks&&this._send(this._datafeedURL+"/marks",{symbol:e.ticker.toUpperCase(),from:t,to:s,resolution:o}).done(function(e){a(JSON.parse(e))}).fail(function(){a([])})},Datafeeds.UDFCompatibleDatafeed.prototype.getTimescaleMarks=function(e,t,s,a,o){this._configuration.supports_timescale_marks&&this._send(this._datafeedURL+"/timescale_marks",{symbol:e.ticker.toUpperCase(),from:t,to:s,resolution:o}).done(function(e){a(JSON.parse(e))}).fail(function(){a([])})},Datafeeds.UDFCompatibleDatafeed.prototype.searchSymbolsByName=function(e,t,s,a){var o=30;if(!this._configuration)return void a([]);if(this._configuration.supports_search)this._send(this._datafeedURL+"/search",{limit:o,query:e.toUpperCase(),type:s,exchange:t}).done(function(e){for(var t=JSON.parse(e),s=0;s<t.length;++s)t[s].params||(t[s].params=[]);a("undefined"==typeof t.s||"error"!=t.s?t:[])}).fail(function(e){a([])});else{if(!this._symbolSearch)throw"Datafeed error: inconsistent configuration (symbol search)";var i={ticker:e,exchange:t,type:s,onResultReadyCallback:a};if(this._initializationFinished)this._symbolSearch.searchSymbolsByName(i,o);else{var n=this;this.on("initialized",function(){n._symbolSearch.searchSymbolsByName(i,o)})}}},Datafeeds.UDFCompatibleDatafeed.prototype._symbolResolveURL="/symbols",Datafeeds.UDFCompatibleDatafeed.prototype.resolveSymbol=function(e,t,s){function a(e){var s=e;o.postProcessSymbolInfo&&(s=o.postProcessSymbolInfo(s)),o._logMessage("Symbol resolved: "+(Date.now()-i)),t(s)}var o=this;if(!this._initializationFinished)return void this.on("initialized",function(){o.resolveSymbol(e,t,s)});var i=Date.now();o._logMessage("Resolve requested"),this._configuration.supports_group_request?this._initializationFinished?this._symbolsStorage.resolveSymbol(e,a,s):this.on("initialized",function(){o._symbolsStorage.resolveSymbol(e,a,s)}):this._send(this._datafeedURL+this._symbolResolveURL,{symbol:e?e.toUpperCase():""}).done(function(e){var t=JSON.parse(e);t.s&&"ok"!=t.s?s("unknown_symbol"):a(t)}).fail(function(e){o._logMessage("Error resolving symbol: "+JSON.stringify([e])),s("unknown_symbol")})},Datafeeds.UDFCompatibleDatafeed.prototype._historyURL="/history",Datafeeds.UDFCompatibleDatafeed.prototype.getBars=function(e,t,s,a,o,i){if(s>0&&(s+"").length>10)throw["Got a JS time instead of Unix one.",s,a];var n=this,r=Date.now(),l=Math.floor(r/1e3),u=e.ticker.toUpperCase();this._send(this._datafeedURL+this._historyURL,{symbol:u,resolution:t,from:s,to:a,nonce:l,hash:SHA256(u+(s&a)+t+l)}).done(function(e){var t=JSON.parse(e),s="no_data"==t.s;if("ok"!=t.s&&!s)return void(i&&i(t.s));for(var a=[],r=s?0:t.t.length,l="undefined"!=typeof t.v,f="undefined"!=typeof t.o,h=0;r>h;++h){var c={time:1e3*t.t[h],close:t.c[h]};f?(c.open=t.o[h],c.high=t.h[h],c.low=t.l[h]):c.open=c.high=c.low=c.close,l&&(c.volume=t.v[h]),a.push(c)}r>0&&(document.title=u+" "+t.c[r-1]),o(a,{version:n._protocolVersion,noData:s,nextTime:t.nb||t.nextTime})}).fail(function(e){console.warn(["getBars(): HTTP error",e]),i&&i("network error: "+JSON.stringify(e))})},Datafeeds.UDFCompatibleDatafeed.prototype.subscribeBars=function(e,t,s,a){this._barsPulseUpdater.subscribeDataListener(e,t,s,a)},Datafeeds.UDFCompatibleDatafeed.prototype.unsubscribeBars=function(e){this._barsPulseUpdater.unsubscribeDataListener(e)},Datafeeds.UDFCompatibleDatafeed.prototype.calculateHistoryDepth=function(e,t,s){},Datafeeds.UDFCompatibleDatafeed.prototype.getQuotes=function(e,t,s){this._send(this._datafeedURL+"/quotes",{symbols:e}).done(function(e){var a=JSON.parse(e);"ok"==a.s?t&&t(a.d):s&&s(a.errmsg)}).fail(function(e){s&&s("network error: "+e)})},Datafeeds.UDFCompatibleDatafeed.prototype.subscribeQuotes=function(e,t,s,a){this._quotesPulseUpdater.subscribeDataListener(e,t,s,a)},Datafeeds.UDFCompatibleDatafeed.prototype.unsubscribeQuotes=function(e){this._quotesPulseUpdater.unsubscribeDataListener(e)},Datafeeds.SymbolsStorage=function(e){this._datafeed=e,this._exchangesList=["All Exchanges","BTCe","Bitfinex","Bitstamp","Okcoin","BTCChina","Coinbase","CoinbaseExchange","Campbx","Itbit","Cryptsy","796","Fybsg","Fybse","Kraken","CexIO","Dgex"],this._exchangesWaitingForData={},this._exchangesDataCache={},this._symbolsInfo={},this._symbolsList=[],this._requestFullSymbolsList()},Datafeeds.SymbolsStorage.prototype._requestFullSymbolsList=function(){for(var e=this,t=(this._datafeed,0);t<this._exchangesList.length;++t){var s=this._exchangesList[t];this._exchangesDataCache.hasOwnProperty(s)||(this._exchangesDataCache[s]=!0,this._exchangesWaitingForData[s]="waiting_for_data",this._datafeed._send(this._datafeed._datafeedURL+"/symbol_info",{group:s}).done(function(t){return function(s){e._onExchangeDataReceived(t,JSON.parse(s)),e._onAnyExchangeResponseReceived(t)}}(s)).fail(function(t){return function(s){e._onAnyExchangeResponseReceived(t)}}(s)))}},Datafeeds.SymbolsStorage.prototype._onExchangeDataReceived=function(e,t){function s(e,t,s){return e[t]instanceof Array?e[t][s]:e[t]}try{for(var a=0;a<t.symbol.length;++a){var o=t.symbol[a],i=s(t,"exchange-listed",a),n=s(t,"exchange-traded",a),r=n+":"+o,l=s(t,"has-intraday",a),u="undefined"!=typeof t.ticker,f={name:o,base_name:[i+":"+o],description:s(t,"description",a),full_name:r,legs:[r],has_intraday:l,has_no_volume:s(t,"has-no-volume",a),listed_exchange:i,exchange:n,minmov:s(t,"minmovement",a)||s(t,"minmov",a),minmove2:s(t,"minmove2",a)||s(t,"minmov2",a),fractional:s(t,"fractional",a),pointvalue:s(t,"pointvalue",a),pricescale:s(t,"pricescale",a),type:s(t,"type",a),session:s(t,"session-regular",a),ticker:u?s(t,"ticker",a):o,timezone:s(t,"timezone",a),supported_resolutions:s(t,"supported-resolutions",a)||this._datafeed.defaultConfiguration().supported_resolutions,force_session_rebuild:s(t,"force-session-rebuild",a)||!1,has_daily:s(t,"has-daily",a)||!0,intraday_multipliers:s(t,"intraday-multipliers",a)||["1","5","15","30","60"],has_fractional_volume:s(t,"has-fractional-volume",a)||!1,has_weekly_and_monthly:s(t,"has-weekly-and-monthly",a)||!1,has_empty_bars:s(t,"has-empty-bars",a)||!1,volume_precision:s(t,"volume-precision",a)||0};this._symbolsInfo[f.ticker]=this._symbolsInfo[o]=this._symbolsInfo[r]=f,this._symbolsList.push(o)}}catch(h){throw"API error when processing exchange `"+e+"` symbol #"+a+": "+h}},Datafeeds.SymbolsStorage.prototype._onAnyExchangeResponseReceived=function(e){delete this._exchangesWaitingForData[e];var t=0===Object.keys(this._exchangesWaitingForData).length;t&&(this._symbolsList.sort(),this._datafeed._logMessage("All exchanges data ready"),this._datafeed.onInitialized())},Datafeeds.SymbolsStorage.prototype.resolveSymbol=function(e,t,s){this._symbolsInfo.hasOwnProperty(e)?t(this._symbolsInfo[e]):s("invalid symbol")},Datafeeds.SymbolSearchComponent=function(e){this._datafeed=e},Datafeeds.SymbolSearchComponent.prototype.searchSymbolsByName=function(e,t){if(!this._datafeed._symbolsStorage)throw"Cannot use local symbol search when no groups information is available";for(var s=this._datafeed._symbolsStorage,a=[],o=!e.ticker||0===e.ticker.length,i=0;i<s._symbolsList.length;++i){var n=s._symbolsList[i],r=s._symbolsInfo[n];if(!(e.type&&e.type.length>0&&r.type!=e.type)&&!(e.exchange&&e.exchange.length>0&&r.exchange!=e.exchange)&&((o||0===r.name.indexOf(e.ticker))&&a.push({symbol:r.name,full_name:r.full_name,description:r.description,exchange:r.exchange,params:[],type:r.type,ticker:r.name}),a.length>=t))break}e.onResultReadyCallback(a)},Datafeeds.DataPulseUpdater=function(e,t){this._datafeed=e,this._subscribers={},this._requestsPending=0;var s=this,a=function(){if(!(s._requestsPending>0))for(var e in s._subscribers){var t=s._subscribers[e],a=t.resolution,o=parseInt((new Date).valueOf()/1e3),i=o-s.periodLengthSeconds(a,10);s._requestsPending++,function(t){s._datafeed.getBars(t.symbolInfo,a,i,o,function(a){if(s._requestsPending--,s._subscribers.hasOwnProperty(e)&&0!==a.length){var o=a[a.length-1];if(isNaN(t.lastBarTime)||!(o.time<t.lastBarTime)){var i=t.listeners,n=!isNaN(t.lastBarTime)&&o.time>t.lastBarTime;if(n){if(a.length<2)throw"Not enough bars in history for proper pulse update. Need at least 2.";for(var r=a[a.length-2],l=0;l<i.length;++l)i[l](r)}t.lastBarTime=o.time;for(var l=0;l<i.length;++l)i[l](o)}}},function(){s._requestsPending--})}(t)}};"undefined"!=typeof t&&t>0&&setInterval(a,t)},Datafeeds.DataPulseUpdater.prototype.unsubscribeDataListener=function(e){this._datafeed._logMessage("Unsubscribing "+e),delete this._subscribers[e]},Datafeeds.DataPulseUpdater.prototype.subscribeDataListener=function(e,t,s,a){this._datafeed._logMessage("Subscribing "+a);e.name+", "+t;this._subscribers.hasOwnProperty(a)||(this._subscribers[a]={symbolInfo:e,resolution:t,lastBarTime:0/0,listeners:[]}),this._subscribers[a].listeners.push(s)},Datafeeds.DataPulseUpdater.prototype.periodLengthSeconds=function(e,t){var s=0;return s="D"==e?t:"M"==e?31*t:"W"==e?7*t:t*e/1440,24*s*60*60},Datafeeds.QuotesPulseUpdater=function(e){this._datafeed=e,this._subscribers={},this._updateInterval=6e4,this._fastUpdateInterval=1e4,this._requestsPending=0;var t=this;setInterval(function(){t._updateQuotes(function(e){return e.symbols})},this._updateInterval),setInterval(function(){t._updateQuotes(function(e){return e.fastSymbols.length>0?e.fastSymbols:e.symbols})},this._fastUpdateInterval)},Datafeeds.QuotesPulseUpdater.prototype.subscribeDataListener=function(e,t,s,a){this._subscribers.hasOwnProperty(a)||(this._subscribers[a]={symbols:e,fastSymbols:t,listeners:[]}),this._subscribers[a].listeners.push(s)},Datafeeds.QuotesPulseUpdater.prototype.unsubscribeDataListener=function(e){delete this._subscribers[e]},Datafeeds.QuotesPulseUpdater.prototype._updateQuotes=function(e){if(!(this._requestsPending>0)){var t=this;for(var s in this._subscribers){this._requestsPending++;var a=this._subscribers[s];this._datafeed.getQuotes(e(a),function(e,s){return function(a){if(t._requestsPending--,t._subscribers.hasOwnProperty(s))for(var o=0;o<e.length;++o)e[o](a)}}(a.listeners,s),function(e){t._requestsPending--})}}};